var myApp=angular.module("sample.products",["ui.router","auth0"])
myApp.config(["$stateProvider","$urlRouterProvider","authProvider",function(e,o,t){e.state("showProductList",{url:"/showProductList?user_id&refresh&pageNumber",controller:"ShowProductListController",templateUrl:"products/showProductList.html",data:{requiresLogin:!1}}),e.state("addProduct",{url:"/addProduct",controller:"AddEditProductController",templateUrl:"products/addEditProduct.html",data:{requiresLogin:!1}}),e.state("editProduct",{url:"/editProduct?id&user_id",controller:"AddEditProductController",templateUrl:"products/addEditProduct.html",data:{requiresLogin:!1}}),e.state("showProduct",{url:"/showProduct?product_id&show",controller:"ShowProductController",templateUrl:"products/showProduct.html",data:{requiresLogin:!1}})}]),myApp.controller("ShowProductController",["$scope","$ionicPopup","$location","PublicService","BackandService","NOTI_CATEGORY","TRANS_TYPE","$state","$stateParams","growl","TRANS_STATUS","USER_LINK_TYPE",function(e,o,t,i,n,r,s,c,u,a,d,l){function g(){e.userInSession.user_id==e.showObject.user_id&&(e.authenticated=!0)}function m(o,t){n.getLinkByFromIdToIdType(o,t,l.LINKED).then(function(o){console.log("getLinkByFromIdToIdType"),200==o.status&&(o.data.length>0?e.linked=!0:e.linked=!1)},function(e){i.errorCallbackFunction(e,"Opps! Something went wrong. Please Refresh Page")})}function P(o){e.loading=!0,n.getShowProductById(o).then(function(t){console.log("Data from show object"),e.showObject=t.data[0],console.log(t),console.log(e.showObject),e.loading=!1,null==e.showObject&&(e.errorMessage="There is no product with id "+o),200==t.status&&null!=e.showObject&&(e.lastUpdatedAgo=i.getAgoTime(e.showObject.updated_at),null==e.showObject.custom_pricing||""==e.showObject.custom_pricing?e.hasCustomPricing=!1:(e.hasCustomPricing=!0,e.customPricingList=JSON.parse(e.showObject.custom_pricing)),null==e.showObject.specification||""==e.showObject.specification?e.hasSpecification=!1:(e.hasSpecification=!0,e.showObject.specification=JSON.parse(e.showObject.specification)),"["==e.showObject.picture[0]?(e.imageList=JSON.parse(e.showObject.picture),console.log(e.imageList)):e.imageList.push(e.showObject.picture),null!=e.userInSession&&(g(),m(e.userInSession.user_id,e.showObject.user_id)))})}function p(){n.deleteObject("products",e.showObject.id).then(function(o){console.log("Data from delete products object"),console.log(o),200==o.status&&(a.success("Click on page title [My Product] to update list.",{title:"Successfully Delete One Product!"}),h(e.showObject.picture),c.go("showProductList",{user_id:e.userInSession.user_id,refresh:"y",pageNumber:1})),e.loading=!1},function(o){a.error("There is one or more transactions associated with this product",{title:"Failed to delete this product"}),console.log(o),e.loading=!1})}function h(e){function o(e){n.deleteFile(e).then(function(e){console.log("Result From Delete Image from Backand"),console.log(e)},function(e){console.log(e)})}if("["==e[0])for(var t=JSON.parse(e),i=0;i<t.length;i++)o(t[i])
else o(e)}e.showObject=null,e.lastUpdated=null,e.hasCustomPricing=null,e.customPricingList=[],e.imageList=[],e.TRANS_TYPE=s,e.productId=u.product_id,e.show=u.show,null==e.show&&(e.show="info"),e.loading=!1,e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),P(e.productId),e.newRequest={},e.delivery_address={},e.newRequest.total_price=0,e.loadingRequest=!1,e.refresh=function(o){console.log("Refresh"),P(e.productId),a.info(o+" is up to date",{title:"Refresh List!"})},e.updateTotalPrice=function(){if(e.hasCustomPricing){for(var o=0,t=0;t<e.customPricingList.length;t++)if(e.newRequest.quantity<=e.customPricingList[t].to){o=e.customPricingList[t].price
break}console.log(o),e.newRequest.total_price=e.newRequest.quantity*o}else e.newRequest.total_price=e.newRequest.quantity*e.showObject.price_per_unit
e.newRequest.total_price=e.newRequest.total_price.toFixed(2),isNaN(e.newRequest.total_price)&&(e.newRequest.total_price=0)},e.editProduct=function(e,o){console.log("Edit Product Page"),c.go("editProduct",{id:e,user_id:o})},e.requestProduct=function(){return e.loadingRequest=!0,null==e.showObject?(i.errorCallbackFunction(null,"Failed to Send Request"),void(e.loadingRequest=!1)):(e.newRequest.from_user_id=e.userInSession.user_id,e.newRequest.to_user_id=e.showObject.user_id,e.newRequest.product_id=e.productId,e.newRequest.status=d.REQUESTED,e.newRequest.payment_status=d.NOT_PAID,e.newRequest.created_at=n.getTimestampinMysql(),e.newRequest.updated_at=n.getTimestampinMysql(),"Pick Up"!=e.newRequest.type&&(console.log(e.delivery_address),e.newRequest.delivery_address=JSON.stringify(e.delivery_address),console.log(e.newRequest.delivery_address)),void n.addObject("transactions",e.newRequest).then(function(o){console.log("Result From Creating new Request"),console.log(o),200==o.status&&(a.success("Click on page title [My Active Listing] to update list.",{title:"Successfully Added New Request!"}),c.go("myActiveListing",{pageNumber:1,refresh:"y"}),n.createNotification(o.data.to_user_id,"New product request from "+e.userInSession.first_name,"/showTransaction?id="+o.data.id+"&other_user_id="+e.userInSession.user_id,r.PRODUCT)),e.loadingRequest=!1},function(o){i.errorCallbackFunction(o,"Failed to Send Request"),e.loadingRequest=!1}))},e.authenticated=!1,e.linked=!1,e.showFunction=function(o){e.show=o},e.comfirmDeleteProduct=function(){e.loading=!1
var t=o.confirm({title:"Are You Sure?",template:"This action cannot be undone."})
t.then(function(o){o&&(e.loading=!0,p())})}}]),myApp.controller("AddEditProductController",["$scope","$http","$ionicPopup","$stateParams","USER_TYPE","BackandService","DropboxService","PublicService","FileReaderService","auth","$state","growl","PICTURE_CONSTANT",function(e,o,t,i,n,r,s,c,u,a,d,l,g){function m(){var o=0,t=!0,i=""
e.doneErrorMessageList=[],0!=e.customPricingList[0].from&&(t=!1,i="The quantity did not start from 0",e.doneErrorMessageList.push(i))
for(var n=0;n<e.customPricingList.length;n++)console.log(e.customPricingList[n]),0!=n&&e.customPricingList[n].from-o!=1&&(t=!1,i="There is a loop hole between "+n+" and "+(n+1),i+=" ["+o+"..."+e.customPricingList[n].from+"]",e.doneErrorMessageList.push(i)),n==e.customPricingList.length-1&&"Infinity"!=e.customPricingList[n].to&&(t=!1,i="The quantity did not end with 'Infinity'",e.doneErrorMessageList.push(i)),o=e.customPricingList[n].to
console.log(e.doneErrorMessageList)}function P(o,t){var i=!0,n=""
return console.log(o),o.from>o.to&&(i=!1,n="[To] cannot be smaller than [From]"),o.from==o.to&&(i=!1,n="[To] cannot be same with [From]"),"edit"==t&&(0!=o.index&&o.from<=e.customPricingList[o.index-1].to&&(i=!1,n="[From] cannot be smaller than [To] of previous"),o.index!=e.customPricingList.length-1&&o.to>=e.customPricingList[o.index+1].from&&(i=!1,n="[To] cannot be larger than [From] of next")),i?i:(l.error(n+"",{title:"Invalid Pricing"}),console.log(i),void console.log(n))}function p(e){h()?f(e):(l.error("Redirecting..",{title:"You are not authenticated to edit this product!"}),d.go("myProducts"))}function h(){if(e.userInSession.user_id==e.product_user_id)return!0}function f(o){r.getShowProductById(o).then(function(o){if(console.log("Data from show object"),e.newProduct=o.data[0],e.oldProduct=o.data[0],e.oldImageSrc=e.newProduct.picture,e.imageSrc=e.newProduct.picture,console.log(e.oldProduct),e.oldProduct.user_id!=e.userInSession.user_id)return l.error("Redirecting to home..",{title:"You are not authenticated to edit this product!"}),void d.go("home")
if(null==e.oldProduct.custom_pricing||""==e.oldProduct.custom_pricing?e.hasCustomPricing=!1:(console.log("getting custom price edit"),e.customPricingList=JSON.parse(e.oldProduct.custom_pricing),e.hasCustomPricing=!0,e.customPricingDone=!0),null==e.oldProduct.specification||""==e.oldProduct.specification||"{}"==e.oldProduct.specification?e.hasSpecification=!1:(console.log("getting custom price edit"),e.specification=JSON.parse(e.oldProduct.specification),e.hasSpecification=!0),"["==e.oldProduct.picture[0]){for(var t=JSON.parse(e.oldProduct.picture),i=0;i<t.length;i++){var n={}
n.filedata="Uploaded",n.file="Uploaded",n.pos=i,n.imageSrc=t[i],e.imageFiles.push(n)}e.imagePos=e.imageFiles.length,console.log(e.imageFiles)}else{var n={}
n.filedata="Uploaded",n.file="Uploaded",n.pos=0,n.imageSrc=e.oldProduct.picture,e.imageFiles.push(n),e.imagePos=1}e.progress=100},function(e){c.errorCallbackFunction(e,"Failed to open product editor!")})}function w(){e.loadingEdit=!0,console.log(e.newProduct),r.editProductById(e.newProduct.id,e.newProduct.name,e.newProduct.category,e.newProduct.price_per_unit,e.newProduct.description,e.newProduct.picture,e.newProduct.quantity,e.newProduct.custom_pricing,e.newProduct.specification,e.newProduct.updated_at).then(function(o){console.log("Result From Editing old Product"),console.log(o),200==o.status&&(l.success("Click on page title [My Product] to update list.",{title:"Successfully Added New Product!"}),e.loadingEdit=!1,e.loading=!1,d.go("showProduct",{product_id:e.newProduct.id}))},function(o){e.loadingEdit=!1,e.loading=!1,c.errorCallbackFunction(o,"Failed to edit product")})}function S(e){return e/1e6}function _(o){return console.log(e.imageFiles),null==o.file?void(e.loadImage=!1):null==o.file.type||"image"!=o.file.type.split("/")[0]?(l.error("File uploaded is not an image. Please try again",{title:"Error Upload Image!"}),void(e.loadImage=!1)):S(o.file.size)>e.imageSizeLimit?(l.error("Image Size is Too Large. Please try again",{title:"Error Upload Image!"}),void(e.loadImage=!1)):(e.imagePos+=1,void u.readAsDataURL(o.file,e).then(function(t){o.imageSrc=t,e.imageFiles.push(o),console.log(e.imageFiles),e.loadImage=!1}))}function F(){function o(){e.newProduct.picture=JSON.stringify(e.newProduct.picture),console.log(e.newProduct.picture),e.showObject=e.newProduct,"editProduct"==e.state&&w(),"addProduct"==e.state&&L()}e.loadStatus="Saving image of your new product.",e.numberUploaded=0,e.loading=!0
var t=0
console.log(e.imageFiles),e.newProduct.picture=[]
for(var i=0;i<e.imageFiles.length;i++)if("Uploaded"!=e.imageFiles[i].filedata&&"Uploaded"!=e.imageFiles[i].file){var n=C(e.imageFiles[i].pos),s=e.imageFiles[i].filedata
r.uploadFile(n,s).then(function(t){console.log("Result From Upload Image to Backand"),console.log(t),200==t.status&&(e.newProduct.picture.push(t.data.url),e.numberUploaded+=1,e.numberUploaded==e.imageFiles.length&&o())},function(e){console.log(e)})}else e.numberUploaded+=1,e.newProduct.picture.push(e.imageFiles[i].imageSrc),console.log("continue"),t+=1
t==e.imageFiles.length&&(console.log("no change in picture"),o())}function L(){e.loadStatus="Creating new record in database",e.newProduct.user_id=e.userInSession.user_id,e.newProduct.specification=JSON.stringify(e.specification),console.log(e.newProduct),r.addObject("products",e.newProduct).then(function(o){console.log("Result From Creating new Product"),console.log(o),200==o.status&&(e.loading=!1,l.success("Click on page title [My Product] to update list.",{title:"Successfully Added New Product!"}),d.go("showProductList",{user_id:e.userInSession.user_id,refresh:"y",pageNumber:1}))},function(o){c.errorCallbackFunction(o,"default"),e.loading=!1})}function C(o){var t=e.imageFiles[o].file.type.split(/[ \/]+/)[1],i=c.getTimestampForFileName(e.newProduct.created_at),n=e.newProduct.name.replace(/\s+/g,"_"),r="user"+e.userInSession.user_id+"_"+n+"_"+o+"_"+i+"."+t
return console.log(r),r}e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.state=d.current.name,"editProduct"==e.state&&(e.editId=i.id,e.product_user_id=i.user_id,p(e.editId)),e.imageSizeLimit=5,e.newProduct={},e.specification={},e.hasSpecification=!1,e.imageFiles=[],e.imagePos=0,e.loading=!1,e.loadStatus="",null==e.userInSession&&(l.error("Redirecting to home",{title:"You Are Not Authenticated to Add New Product"}),d.go("home")),null!=e.userInSession&&e.userInSession.user_type>n.STOCKIST&&(l.error("Redirecting to home",{title:"You Could Not Add New Product"}),d.go("home")),e.hasCustomPricing=!1,e.customPricingDone=!1,e.showCustomPricingForm=!1,e.showCustomPricingFormEdit=!1,e.showCustomPricingFormLast=!1,e.newCustomPricing={},e.tempCustomPricing={},e.editIndex=0,e.customPricingList=[],e.index=0,e.newCustomPricing.from=0,e.doneErrorMessageList=[],e.toggleShowCustomPricingForm=function(){e.showCustomPricingForm?e.showCustomPricingForm=!1:e.showCustomPricingForm=!0},e.customPricingOperation=function(o,t){"cancel"==o&&(e.showCustomPricingForm=!1,e.showCustomPricingFormEdit=!1,e.showCustomPricingFormLast=!1),"add"==o&&(console.log(e.customPricingList),e.showCustomPricingForm=!0,e.showCustomPricingFormEdit=!1,e.showCustomPricingFormLast=!1),"addLast"==o&&(e.showCustomPricingForm=!1,e.showCustomPricingFormEdit=!1,e.showCustomPricingFormLast=!0,e.newCustomPricing.to="Infinity"),"edit"==o&&(e.showCustomPricingForm=!1,e.showCustomPricingFormEdit=!0,e.showCustomPricingFormLast=!1,e.tempCustomPricing=JSON.parse(JSON.stringify(e.customPricingList[t])),e.editIndex=t)},e.removeLastCustomPrice=function(){console.log(e.index),0==e.index&&(e.index=e.customPricingList.length),e.index--,e.customPricingList.pop()
var o=0
e.customPricingList.length>0&&(o=e.customPricingList[e.index-1].to+1),e.customPricingDone=!1,e.newCustomPricing={},e.newCustomPricing.from=o},e.editCustomPricing=function(o){P(e.tempCustomPricing,"edit")&&(console.log("edit success "+e.editIndex),e.customPricingList[e.tempCustomPricing.index]=JSON.parse(JSON.stringify(e.tempCustomPricing)),e.customPricingOperation("cancel",0),e.customPricingDone&&m())},e.addCustomPricing=function(){if(P(e.newCustomPricing,"add")){e.newCustomPricing.index=e.index,e.index++
var o=e.newCustomPricing
e.customPricingList.push(o)
var t=e.newCustomPricing.to+1
e.newCustomPricing={},e.newCustomPricing.from=t,e.showCustomPricingFormLast&&(e.customPricingDone=!0),e.customPricingOperation("cancel",0),e.customPricingDone&&m()}},e.removeCustomPricing=function(o){e.newCustomPricing.index=e.index},e.toogleHasSpecification=function(){e.hasSpecification?e.hasSpecification=!1:e.hasSpecification=!0,console.log(e.hasSpecification)},e.toogleHasCustomPricing=function(){e.hasCustomPricing?e.hasCustomPricing=!1:e.hasCustomPricing=!0,console.log(e.hasCustomPricing)},e.editProduct=function(){e.loading=!0,e.newProduct.updated_at=r.getTimestampinMysql(),console.log(e.hasCustomPricing),e.hasCustomPricing?(e.newProduct.custom_pricing=JSON.stringify(e.customPricingList),e.newProduct.price_per_unit=0):e.newProduct.custom_pricing=null,console.log("spec "+e.hasSpecification),e.hasSpecification?(console.log("here"),e.newProduct.specification=JSON.stringify(e.specification),console.log(e.newProduct)):e.newProduct.specification=null,console.log(e.newProduct),0==e.imageFiles.length?(e.newProduct.picture=g.UNAVAILABLE,w()):F()},e.checkRemovePicture=function(o){var i=t.confirm({title:"Are you sure you want to remove this picture?",template:"This action cannot be undone"})
i.then(function(t){t&&e.removePicture(o)})},e.removePicture=function(o){if(console.log("Emptying "+o),"Uploaded"==e.imageFiles[o].file){console.log("Delete File From Server")
var t=e.imageFiles[o].imageSrc
r.deleteFile(t).then(function(e){200==e.status&&c.successCallbackFunction(t,"Successfully Deleted One Picture From Server")},function(e){c.errorCallbackFunction(e,"Failed to delete picture from server")})}if(1==e.imageFiles.length)return e.imageFiles=[],void(e.imagePos=0)
e.imageFiles.splice(o,1)
for(var i=0;i<e.imageFiles.length;i++)i>=o&&(e.imageFiles[i].pos-=1)
console.log(e.imageFiles),e.imagePos-=1,e.progress=0},e.loadImage=!1,e.addPicture=function(){e.progress=null
var o=document.getElementById("file").files[0],t=new FileReader,i=!1
t.onload=function(t){var n={}
n.filedata=t.currentTarget.result,n.file=o,n.pos=e.imagePos,null!=t.currentTarget.result?(i=!0,console.log("valid"),_(n)):(i=!1,console.log("not valid"))},t.readAsDataURL(o)},e.$on("fileProgress",function(o,t){e.progress=t.loaded/t.total*100}),e.createNewProduct=function(){e.loading=!0,e.newProduct.created_at=r.getTimestampinMysql(),e.newProduct.updated_at=r.getTimestampinMysql(),e.hasCustomPricing?(e.newProduct.custom_pricing=JSON.stringify(e.customPricingList),e.newProduct.price_per_unit=0):e.newProduct.custom_pricing="",0==e.imageFiles.length?(e.newProduct.picture=g.UNAVAILABLE,console.log(e.newProduct),L()):F()}}]),myApp.controller("ShowProductListController",["$scope","growl","OFFSET","SearchService","USER_TYPE","USER_LINK_TYPE","$stateParams","BackandService","PublicService","$state",function(e,o,t,i,n,r,s,c,u,a){function d(o){var t=0
try{t=o.length}catch(e){console.log(e)}t<3||(e.searchLoad=!0,i.searchProductByNameByCategory(o,e.userObject.id).then(function(o){e.searchProduct=o.data,console.log(o),e.searchLoad=!1},function(o){u.errorCallbackFunction(o,"default"),e.searchLoad=!1}))}function l(){null!=e.userInSession&&e.userInSession.user_id==s.user_id&&(e.isMyProduct=!0)}function g(o){e.loading=!0,c.getUserNameTypeById(o).then(function(o){console.log(o),e.userObject.user_name=o.data[0].user_name,e.userObject.user_type=o.data[0].user_type,e.loading=!1},function(o){u.errorCallbackFunction(o,"default"),e.loading=!1})}function m(o){c.getProductCountByUserId(o).then(function(o){console.log(o),(o.status=200)&&(e.totalProduct=o.data[0].total_product)},function(e){u.errorCallbackFunction(e,"default")})}function P(o){e.loading=!0,c.getAllProductByUserId(o,e.pageNumber).then(function(o){console.log("Result From getAllProductByUserId"),console.log(o),200==o.status&&(0==e.productList.length?e.productList=o.data:e.productList=e.productList.concat(o.data),e.loadedProduct=e.productList.length),e.loading=!1},function(o){u.errorCallbackFunction(o,"default"),e.loading=!1})}function p(o,t){c.getLinkByFromIdToIdType(o,t,r.LINKED).then(function(o){console.log("getLinkByFromIdToIdType"),200==o.status&&(o.data.length>0?e.linked=!0:e.linked=!1,e.loadingLink=!1)},function(o){u.errorCallbackFunction(o,"Failed to check users connection"),e.loadingLink=!1})}e.userObject={},e.userObject.id=s.user_id,e.productList=[],e.showItem={},e.loadingLink=!1,e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),e.linked=null,e.isMyProduct=!1,e.refresh=function(){console.log("Refresh"),e.pageNumber=1,e.productList=[],P(s.user_id),m(e.userObject.id),o.info("List is up to date",{title:"Refresh List!"})},e.pageNumber=s.pageNumber,console.log(e.pageNumber),e.OFFSET=t,e.search={},e.searchProduct=[],e.searchLoad=!1,e.isSubmit=!1,e.submit=function(){e.search.key&&""!=e.search.key||(e.searchProduct=[]),e.isSubmit=!0,d(e.search.key)},l(),e.isMyProduct||g(e.userObject.id),null==e.linked&&(e.loadingLink=!0,null!=e.userInSession?(p(e.userObject.id,e.userInSession.user_id),m(e.userObject.id),P(e.userObject.id)):(e.loadingLink=!1,e.linked=!1)),e.getMore=function(){console.log(e.pageNumber),e.pageNumber=Number(e.pageNumber)+1,console.log(e.pageNumber),P(e.userObject.id)},e.showProduct=function(e,o){console.log("Show Product Page"),a.go("showProduct",{product_id:e,show:o})},e.loadedProduct=0,e.totalProduct=0,e.toggleItem=function(o){e.isItemShown(o)?e.showItem=null:(e.showItem=o,e.timeAgo=u.getAgoTime(o.updated_at))},e.isItemShown=function(o){return e.showItem===o},e.addProduct=function(){console.log("Add Product Page"),a.go("addProduct")},e.editProduct=function(e,o){console.log("Edit Product Page"),a.go("editProduct",{id:e,user_id:o})}}])
