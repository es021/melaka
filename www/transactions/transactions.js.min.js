var myApp=angular.module("sample.transactions",["ui.router","backand","auth0"])
myApp.config(["$stateProvider","BackandProvider",function(t,e){t.state("myActiveListing",{url:"/myActiveListing?pageNumber&refresh",controller:"TransactionsController",templateUrl:"transactions/myActiveListing.html",data:{requiresLogin:!0}}),t.state("myCompletedTransaction",{url:"/myCompletedTransaction?pageNumber&refresh",controller:"TransactionsController",templateUrl:"transactions/myActiveListing.html",data:{requiresLogin:!0}}),t.state("showTransaction",{url:"/showTransaction?id&other_user_id&show",controller:"TransactionsController",templateUrl:"transactions/showTransaction.html",data:{requiresLogin:!0}}),t.state("transactionsSortByAgent",{url:"/transactionsSortByAgent",controller:"TransactionsSortByAgentController",templateUrl:"transactions/transactionsSortByAgent.html",data:{requiresLogin:!0}})}]),myApp.controller("TransactionsSortByAgentController",["$state","OFFSET","$stateParams","growl","TRANS_TYPE","$scope","BackandService","PublicService","TRANS_STATUS",function(t,e,o,n,i,a,s,r,l){function u(t){a.userListLoad=!0,s.getOtherUserListFromTransaction(t).then(function(t){console.log(t.data),200==t.status&&(a.userList=t.data,a.userListLoad=!1)},function(t){r.errorCallbackFunction(t,"default"),a.userListLoad=!1})}function c(t,e){a.showItemLoad=!0,s.getTransactionByOtherUserId(t,e).then(function(t){console.log(t.data),200==t.status&&(a.transactions=t.data,a.showItemLoad=!1)},function(t){r.errorCallbackFunction(t,"default"),a.showItemLoad=!1})}a.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),a.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),a.userList={},a.transactions={},a.showItem={},a.userListLoad=!1,a.showItemLoad=!1,a.TRANS_STATUS=l,a.TRANS_TYPE=i,u(a.userInSession.user_id),a.toggleItem=function(t){a.isItemShown(t)?a.showItem=null:(c(a.userInSession.user_id,t.id),a.showItem=t)},a.isItemShown=function(t){return a.showItem===t}}]),myApp.controller("TransactionsController",["$state","OFFSET","$stateParams","growl","NOTI_CATEGORY","TRANS_TYPE","$ionicPopup","$scope","BackandService","PublicService","FileReaderService","auth","TRANS_STATUS",function(t,e,o,n,i,a,s,r,l,u,c,d,m){function f(){null!=r.authProfile&&null!=r.userInSession&&(r.loading=!0,"myActiveListing"==t.current.name&&h(r.userInSession.user_id),"myCompletedTransaction"==t.current.name&&p(r.userInSession.user_id),"showTransaction"==t.current.name&&(T(o.id,o.other_user_id),null!=o.show&&(r.show=o.show,console.log(r.show))))}function h(t){l.getUserActiveListing(t,r.pageNumber).then(function(t){r.activeListing=t.data,console.log(r.activeListing),r.loading=!1})}function p(t){l.getUserCompletedTransaction(t,r.pageNumber).then(function(t){r.activeListing=t.data,r.loading=!1})}function g(t,e,o){var n=r.showItem.other_user_id,a="",s="/showTransaction?id="+t+"&other_user_id="+r.userInSession.user_id,u=0,c=r.userInSession.first_name
if("status"==e){switch(o){case m.DENIED:a=c+" DENIED your product request"
break
case m.APPROVED:a=c+" APPROVED your product request"
break
case m.DELIVERED:a=c+" has DELIVERED your package"
break
case m.RECEIVED:a=c+" has CONFIRMED package received"}u=i.TRANSACTION}if("payment_status"==e){switch(o){case m.PAID:a=c+" has PAID for the product request"
break
case m.COMFIRMED:a=c+" has CONFIRMED payment received"}u=i.PAYMENT}w(),l.createNotification(n,a,s,u)}function w(){function t(t,e,o){var n=r.showItem.from_user_id,a="",s="/showProduct?product_id="+e+"&show=info",u=i.PRODUCT
r.userInSession.first_name
"new"==t&&(a="New product ["+o+"] has been added to your inventory."),"update"==t&&(a="Quantity product ["+o+"] has been updated."),l.createNotification(n,a,s,u)}function e(e){l.getObjectById("products",e).then(function(e){console.log("getObjectById"),r.oldProduct=e.data,console.log(r.showProduct),200==e.status&&(r.newProduct.user_id=r.showItem.from_user_id,r.newProduct.parent_id=r.showItem.product_id,r.newProduct.quantity=r.showItem.quantity,r.newProduct.created_at=r.showItem.updated_at,r.newProduct.updated_at=r.showItem.updated_at,r.newProduct.name=r.oldProduct.name,r.newProduct.category=r.oldProduct.category,r.newProduct.picture=r.oldProduct.picture,r.newProduct.description=r.oldProduct.description,r.newProduct.price_per_unit=r.oldProduct.price_per_unit,r.newProduct.custom_pricing=r.oldProduct.custom_pricing,r.newProduct.specification=r.oldProduct.specification,l.addObject("products",r.newProduct).then(function(e){console.log("addObject"),console.log(e),200==e.status&&t("new",e.data.id,e.data.name)}))},function(t){u.errorCallbackFunction(t,"default")})}function o(){console.log("addNewProduct"),e(r.showItem.product_id)}function n(){console.log("updateOldProduct")
var e=r.oldProduct.quantity+r.showItem.quantity
console.log(e),l.editProductQuantity(r.oldProduct.id,e).then(function(e){console.log("editProductQuantity"),console.log(e),console.log(200==e.status),t("update",r.oldProduct.id,r.oldProduct.name)},function(t){u.errorCallbackFunction(t,"default")})}function a(t,e){console.log("checkIfNewProduct"),l.getProductbyUserIdParentId(t,e).then(function(t){console.log(t),200==t.status&&(t.data.length>0?(r.isNewProduct=!1,r.oldProduct=t.data[0],n()):(r.isNewProduct=!0,o()))},function(t){u.errorCallbackFunction(t,"default")})}r.isNewProduct=!1,r.oldProduct={},r.newProduct={},console.log("postActionTransacation"),"Delivery"==r.showItem.type&&r.showItem.status==m.RECEIVED&&r.showItem.payment_status==m.COMFIRMED||"Pick Up"==r.showItem.type&&r.showItem.status==m.APPROVED&&r.showItem.payment_status==m.COMFIRMED?a(r.showItem.from_user_id,r.showItem.product_id):console.log("Skipping")}function I(t,e,o){l.editTransactionStatus(t,e,o).then(function(o){_(t,o.status),200==o.status&&(r.showItem.status=e,g(t,"status",e),S(e))},function(t){u.errorCallbackFunction(t,"Opps! Something went wrong")})}function y(t,e,o){l.editTransactionPaymentStatus(t,e,o).then(function(o){_(t,o.status),200==o.status&&(r.showItem.payment_status=e,g(t,"payment_status",e),S(e))},function(t){u.errorCallbackFunction(t,"Opps! Something went wrong")})}function _(t,e){200==e?n.success("Updated Transaction "+t,{title:"Successfully Updated!"}):n.error("Failed to update transactions "+t+". Please try again.",{title:"Error!"})}function P(t,e,o){r.loadStatus="Editing transaction record",r.loadingFile=!0
var n=r.showItem.other_user_id,a="/showTransaction?id="+r.showItem.id+"&other_user_id="+r.userInSession.user_id,s=0,c=r.userInSession.first_name,d=u.getTimestampinMysql(),m=""
"request"==e&&(m=c+" request you to add a proof of "+t,a+="&show=add_"+t+"_detail"),"link"==e&&(m=c+" added a proof of "+t),"delivery"==t&&(s=i.TRANSACTION,l.editDeliveryDetailByTransId(r.showItem.id,o,d).then(function(t){200==t.status&&(r.showItem.delivery_detail=o,l.createNotification(n,m,a,s),r.loadingFile=!1,r.show="info")},function(t){u.errorCallbackFunction(t,"default"),r.loadingFile=!1})),"payment"==t&&(s=i.PAYMENT,l.editPaymentDetailByTransId(r.showItem.id,o,d).then(function(t){200==t.status&&(r.showItem.payment_detail=o,l.createNotification(n,m,a,s),r.show="info",r.loadingFile=!1)},function(t){u.errorCallbackFunction(t,"default"),r.loadingFile=!1}))}function S(t){if(t==m.APPROVED&&(console.log("post action"),l.editProductQuantity(r.showItem.product_id,r.product_quantity).then(function(t){},function(t){u.errorCallbackFunction(t,"default")})),t==m.DELIVERED){var e=s.confirm({title:"Delivery Status Successfully Updated",template:"Do you want to upload a proof of delivery?"})
e.then(function(t){t&&r.setShow("add_delivery_detail")})}if(t==m.PAID){var e=s.confirm({title:"Payment Status Successfully Updated",template:"Do you want to upload a proof of payment?"})
e.then(function(t){t&&r.setShow("add_payment_detail")})}}function T(t,e){l.getTransById(t,e).then(function(o){r.showItem=o.data[0],console.log(r.showItem),null==r.showItem&&(r.errorMessage="There is no transaction with id "+t+" and other_user_id "+e),200==o.status&&null!=r.showItem&&(r.showItem.delivery_address=JSON.parse(r.showItem.delivery_address),console.log(r.showItem),""==r.showItem.payment_detail&&(r.showItem.payment_detail=null),""==r.showItem.delivery_detail&&(r.showItem.delivery_detail=null),r.timeAgo=u.getAgoTime(r.showItem.updated_at)),r.loading=!1},function(t){u.errorCallbackFunction(t,"Opps! Something went wrong"),r.loading=!1})}function v(t){return t/1e6}function A(){return console.log(r.file),console.log(r.file.type),console.log(r.file.type.split("/")[1]),null==r.file?void r.removePicture():"image"!=r.file.type.split("/")[0]&&"pdf"!=r.file.type.split("/")[1]?(n.error("File uploaded is not an image or pdf. Please try again",{title:"Error Upload File!"}),void(r.file=null)):v(r.file.size)>r.imageSizeLimit?(n.error("File Size is Too Large. Please try again",{title:"Error Upload File!"}),void(r.file=null)):(r.progress=null,void c.readAsDataURL(r.file,r).then(function(t){"image"==r.file.type.split("/")[0]&&(r.imageSrc=t)}))}function N(t){r.loadStatus="Saving file to the server. Might be a while depending on the size of the file."
var e=F(t),o=r.filedata
l.uploadFile(e,o).then(function(e){console.log("Result From Upload Image to Backand"),console.log(e),200==e.status&&(r.file_link=e.data.url,P(t,"link",r.file_link)),r.loadingFile=!1},function(t){console.log(t),r.loadingFile=!1})}function F(t){var e=r.file.type.split(/[ \/]+/)[1],o=u.getTimestampForFileName(u.getTimestampinMysql()),n="transactions"+r.showItem.id+"_"+t+"_"+o+"."+e
return n}r.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),r.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),r.activeListing={},r.showItem={},r.product_quantity=null,r.TRANS_STATUS=m,r.TRANS_TYPE=a,r.stateName=t.current.name,r.loading=!1,r.show="info",r.pageNumber=o.pageNumber,console.log(r.pageNumber),r.OFFSET=e,f(),r.showProduct=function(){t.go("showProduct",{product_id:r.showItem.product_id,show:"info"})},r.openLink=function(t){"delivery_detail"==t&&(t=r.showItem.delivery_detail),"payment_detail"==t&&(t=r.showItem.payment_detail),console.log(t)
var e=window.open(t,"_blank")
e.focus()},r.refresh=function(t){console.log("Refresh"),f(),n.info(t+" is up to date",{title:"Refresh List!"})},r.getMore=function(e){console.log(e)
var o=r.pageNumber
"next"==e&&(o=Number(r.pageNumber)+1),"previous"==e&&(o=Number(r.pageNumber)-1),console.log(o),t.go(t.current.name,{pageNumber:o})},r.approveTrans=function(t){l.getProductQuantity(t).then(function(t){200==t.status&&(console.log(t),r.product_quantity=t.data[0].quantity,console.log(r.product_quantity),r.showItem.quantity<=r.product_quantity?(console.log("Valid to be approved"),r.product_quantity-=r.showItem.quantity,console.log(r.product_quantity),r.updateTrans(r.showItem.id,"status",m.APPROVED)):n.error("The quantity of product '"+r.showItem.product_name+"' is less than amount requested",{title:"Failed to approve request!"}))},function(t){u.errorCallbackFunction(t,"default")})},r.updateTrans=function(t,e,o){console.log(t+" "+e+" "+o)
var n=l.getTimestampinMysql()
"status"==e&&I(t,o,n),"payment_status"==e&&y(t,o,n)},r.confirmDeleteTrans=function(e){function o(e){l.deleteObject("transactions",e).then(function(o){200==o.status&&(n.success("Deleted Transaction "+e,{title:"Successfully Removed Request!"}),t.go("myActiveListing",{pageNumber:1,refresh:"y"}))})}var i=s.confirm({title:"Remove This Request",template:"Are you sure?"})
i.then(function(t){t&&o(e)})},r.requestDetail=function(t){var e=s.confirm({title:"Remind "+r.showItem.other_user_name,template:"to add a proof of "+t+"?"})
e.then(function(e){e&&P(t,"request","requested")})},r.setShow=function(t){r.show=t},r.showTransaction=function(){console.log(r.showItem.id),t.go("showTransaction",{id:r.showItem.id,other_user_id:r.showItem.other_user_id})},r.goTo=function(e){t.go(e)},r.toggleItem=function(t){r.isItemShown(t)?r.showItem=null:(r.timeAgo=u.getAgoTime(t.updated_at),r.showItem=t)},r.isItemShown=function(t){return r.showItem===t},r.imageSizeLimit=2,r.filePath=null,r.fileToUpload={},r.file=null,r.filedata=null,r.imageSrc=null,r.progress=null,r.filename="",r.loadingFile=!1,r.loadStatus="",r.file_link="",r.loadImage=!1,r.removePicture=function(){r.filePath=null,r.fileToUpload={},r.file=null,r.filedata=null,r.imageSrc=null,r.progress=null},r.addPicture=function(){r.loadImage=!0
var t=document.getElementById("file").files[0],e=new FileReader
e.onload=function(e){r.filedata=e.currentTarget.result,r.filename=t.name,r.file=t,r.loadImage=!1,A()},e.readAsDataURL(t)},r.$on("fileProgress",function(t,e){r.progress=e.loaded/e.total*100}),r.submitFile=function(t){r.loadingFile=!0
var t=r.show.split("_")[1]
console.log(t),N(t)}}])
