var myApp=angular.module("sample.transactions",["ui.router","backand","auth0"])
myApp.config(["$stateProvider","BackandProvider",function(e,t){e.state("myActiveListing",{url:"/myActiveListing?pageNumber&refresh",controller:"TransactionsController",templateUrl:"transactions/myActiveListing.html",data:{requiresLogin:!0}}),e.state("myCompletedTransaction",{url:"/myCompletedTransaction?pageNumber&refresh",controller:"TransactionsController",templateUrl:"transactions/myActiveListing.html",data:{requiresLogin:!0}}),e.state("showTransaction",{url:"/showTransaction?id&other_user_id&show",controller:"TransactionsController",templateUrl:"transactions/showTransaction.html",data:{requiresLogin:!0}})}]),myApp.controller("TransactionsController",["$state","OFFSET","$stateParams","growl","NOTI_CATEGORY","$ionicPopup","$scope","BackandService","PublicService","FileReaderService","auth","TRANS_STATUS",function(e,t,o,n,i,a,s,r,l,u,c,d){function m(){null!=s.authProfile&&null!=s.userInSession&&(s.loading=!0,"myActiveListing"==e.current.name&&f(s.userInSession.user_id),"myCompletedTransaction"==e.current.name&&p(s.userInSession.user_id),"showTransaction"==e.current.name&&(v(o.id,o.other_user_id),null!=o.show&&(s.show=o.show,console.log(s.show))))}function f(e){r.getUserActiveListing(e,s.pageNumber).then(function(e){s.activeListing=e.data,console.log(s.activeListing),s.loading=!1})}function p(e){r.getUserCompletedTransaction(e,s.pageNumber).then(function(e){s.activeListing=e.data,s.loading=!1})}function h(e,t,o){var n=s.showItem.other_user_id,a="",l="/showTransaction?id="+e+"&other_user_id="+s.userInSession.user_id,u=0,c=s.userInSession.first_name
if("status"==t){switch(o){case d.DENIED:a=c+" DENIED your product request"
break
case d.APPROVED:a=c+" APPROVED your product request"
break
case d.DELIVERED:a=c+" has DELIVERED your package"
break
case d.RECEIVED:a=c+" has CONFIRMED package received"}u=i.TRANSACTION}if("payment_status"==t){switch(o){case d.PAID:a=c+" has PAID for the product request"
break
case d.COMFIRMED:a=c+" has CONFIRMED payment received"}u=i.PAYMENT}g(),r.createNotification(n,a,l,u)}function g(){function e(e,t,o){var n=s.showItem.from_user_id,a="",l="/showProduct?product_id="+t+"&show=info",u=i.PRODUCT
s.userInSession.first_name
"new"==e&&(a="New product ["+o+"] has been added to your inventory."),"update"==e&&(a="Quantity product ["+o+"] has been updated."),r.createNotification(n,a,l,u)}function t(t){r.getObjectById("products",t).then(function(t){console.log("getObjectById"),s.oldProduct=t.data,console.log(s.showProduct),200==t.status&&(s.newProduct.user_id=s.showItem.from_user_id,s.newProduct.parent_id=s.showItem.product_id,s.newProduct.quantity=s.showItem.quantity,s.newProduct.created_at=s.showItem.updated_at,s.newProduct.updated_at=s.showItem.updated_at,s.newProduct.name=s.oldProduct.name,s.newProduct.category=s.oldProduct.category,s.newProduct.picture=s.oldProduct.picture,s.newProduct.description=s.oldProduct.description,s.newProduct.price_per_unit=s.oldProduct.price_per_unit,s.newProduct.custom_pricing=s.oldProduct.custom_pricing,s.newProduct.specification=s.oldProduct.specification,r.addObject("products",s.newProduct).then(function(t){console.log("addObject"),console.log(t),200==t.status&&e("new",t.data.id,t.data.name)}))},function(e){l.errorCallbackFunction(e,"default")})}function o(){console.log("addNewProduct"),t(s.showItem.product_id)}function n(){console.log("updateOldProduct")
var t=s.oldProduct.quantity+s.showItem.quantity
console.log(t),r.editProductQuantity(s.oldProduct.id,t).then(function(t){console.log("editProductQuantity"),console.log(t),console.log(200==t.status),e("update",s.oldProduct.id,s.oldProduct.name)},function(e){l.errorCallbackFunction(e,"default")})}function a(e,t){console.log("checkIfNewProduct"),r.getProductbyUserIdParentId(e,t).then(function(e){console.log(e),200==e.status&&(e.data.length>0?(s.isNewProduct=!1,s.oldProduct=e.data[0],n()):(s.isNewProduct=!0,o()))},function(e){l.errorCallbackFunction(e,"default")})}s.isNewProduct=!1,s.oldProduct={},s.newProduct={},console.log("postActionTransacation"),"Delivery"==s.showItem.type&&s.showItem.status==d.RECEIVED&&s.showItem.payment_status==d.COMFIRMED||"Pick Up"==s.showItem.type&&s.showItem.status==d.APPROVED&&s.showItem.payment_status==d.COMFIRMED?a(s.showItem.from_user_id,s.showItem.product_id):console.log("Skipping")}function w(e,t,o){r.editTransactionStatus(e,t,o).then(function(o){I(e,o.status),200==o.status&&(s.showItem.status=t,h(e,"status",t),P(t))},function(e){l.errorCallbackFunction(e,"Opps! Something went wrong")})}function y(e,t,o){r.editTransactionPaymentStatus(e,t,o).then(function(o){I(e,o.status),200==o.status&&(s.showItem.payment_status=t,h(e,"payment_status",t),P(t))},function(e){l.errorCallbackFunction(e,"Opps! Something went wrong")})}function I(e,t){200==t?n.success("Updated Transaction "+e,{title:"Successfully Updated!"}):n.error("Failed to update transactions "+e+". Please try again.",{title:"Error!"})}function _(e,t,o){s.loadStatus="Editing transaction record",s.loadingFile=!0
var n=s.showItem.other_user_id,a="/showTransaction?id="+s.showItem.id+"&other_user_id="+s.userInSession.user_id,u=0,c=s.userInSession.first_name,d=l.getTimestampinMysql(),m=""
"request"==t&&(m=c+" request you to add a proof of "+e,a+="&show=add_"+e+"_detail"),"link"==t&&(m=c+" added a proof of "+e),"delivery"==e&&(u=i.TRANSACTION,r.editDeliveryDetailByTransId(s.showItem.id,o,d).then(function(e){200==e.status&&(s.showItem.delivery_detail=o,r.createNotification(n,m,a,u),s.loadingFile=!1,s.show="info")},function(e){l.errorCallbackFunction(e,"default"),s.loadingFile=!1})),"payment"==e&&(u=i.PAYMENT,r.editPaymentDetailByTransId(s.showItem.id,o,d).then(function(e){200==e.status&&(s.showItem.payment_detail=o,r.createNotification(n,m,a,u),s.show="info",s.loadingFile=!1)},function(e){l.errorCallbackFunction(e,"default"),s.loadingFile=!1}))}function P(e){if(e==d.APPROVED&&(console.log("post action"),r.editProductQuantity(s.showItem.product_id,s.product_quantity).then(function(e){},function(e){l.errorCallbackFunction(e,"default")})),e==d.DELIVERED){var t=a.confirm({title:"Delivery Status Successfully Updated",template:"Do you want to upload a proof of delivery?"})
t.then(function(e){e&&s.setShow("add_delivery_detail")})}if(e==d.PAID){var t=a.confirm({title:"Payment Status Successfully Updated",template:"Do you want to upload a proof of payment?"})
t.then(function(e){e&&s.setShow("add_payment_detail")})}}function v(e,t){r.getTransById(e,t).then(function(o){s.showItem=o.data[0],console.log(s.showItem),null==s.showItem&&(s.errorMessage="There is no transaction with id "+e+" and other_user_id "+t),200==o.status&&null!=s.showItem&&(s.showItem.delivery_address=JSON.parse(s.showItem.delivery_address),console.log(s.showItem),""==s.showItem.payment_detail&&(s.showItem.payment_detail=null),""==s.showItem.delivery_detail&&(s.showItem.delivery_detail=null),s.timeAgo=l.getAgoTime(s.showItem.updated_at)),s.loading=!1},function(e){l.errorCallbackFunction(e,"Opps! Something went wrong"),s.loading=!1})}function T(e){return e/1e6}function S(){return console.log(s.file),console.log(s.file.type),console.log(s.file.type.split("/")[1]),null==s.file?void s.removePicture():"image"!=s.file.type.split("/")[0]&&"pdf"!=s.file.type.split("/")[1]?(n.error("File uploaded is not an image or pdf. Please try again",{title:"Error Upload File!"}),void(s.file=null)):T(s.file.size)>s.imageSizeLimit?(n.error("File Size is Too Large. Please try again",{title:"Error Upload File!"}),void(s.file=null)):(s.progress=null,void u.readAsDataURL(s.file,s).then(function(e){"image"==s.file.type.split("/")[0]&&(s.imageSrc=e)}))}function b(e){s.loadStatus="Saving file to the server. Might be a while depending on the size of the file."
var t=N(e),o=s.filedata
r.uploadFile(t,o).then(function(t){console.log("Result From Upload Image to Backand"),console.log(t),200==t.status&&(s.file_link=t.data.url,_(e,"link",s.file_link)),s.loadingFile=!1},function(e){console.log(e),s.loadingFile=!1})}function N(e){var t=s.file.type.split(/[ \/]+/)[1],o=l.getTimestampForFileName(l.getTimestampinMysql()),n="transactions"+s.showItem.id+"_"+e+"_"+o+"."+t
return n}s.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),s.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),s.activeListing={},s.showItem={},s.product_quantity=null,s.TRANS_STATUS=d,s.stateName=e.current.name,s.loading=!1,s.show="info",s.pageNumber=o.pageNumber,console.log(s.pageNumber),s.OFFSET=t,m(),s.showProduct=function(){e.go("showProduct",{product_id:s.showItem.product_id,show:"info"})},s.openLink=function(e){"delivery_detail"==e&&(e=s.showItem.delivery_detail),"payment_detail"==e&&(e=s.showItem.payment_detail),console.log(e)
var t=window.open(e,"_blank")
t.focus()},s.refresh=function(e){console.log("Refresh"),m(),n.info(e+" is up to date",{title:"Refresh List!"})},s.getMore=function(t){console.log(t)
var o=s.pageNumber
"next"==t&&(o=Number(s.pageNumber)+1),"previous"==t&&(o=Number(s.pageNumber)-1),console.log(o),e.go(e.current.name,{pageNumber:o})},s.approveTrans=function(e){r.getProductQuantity(e).then(function(e){200==e.status&&(console.log(e),s.product_quantity=e.data[0].quantity,console.log(s.product_quantity),s.showItem.quantity<=s.product_quantity?(console.log("Valid to be approved"),s.product_quantity-=s.showItem.quantity,console.log(s.product_quantity),s.updateTrans(s.showItem.id,"status",d.APPROVED)):n.error("The quantity of product '"+s.showItem.product_name+"' is less than amount requested",{title:"Failed to approve request!"}))},function(e){l.errorCallbackFunction(e,"default")})},s.updateTrans=function(e,t,o){console.log(e+" "+t+" "+o)
var n=r.getTimestampinMysql()
"status"==t&&w(e,o,n),"payment_status"==t&&y(e,o,n)},s.confirmDeleteTrans=function(t){function o(t){r.deleteObject("transactions",t).then(function(o){200==o.status&&(n.success("Deleted Transaction "+t,{title:"Successfully Removed Request!"}),e.go("myActiveListing",{pageNumber:1,refresh:"y"}))})}var i=a.confirm({title:"Remove This Request",template:"Are you sure?"})
i.then(function(e){e&&o(t)})},s.requestDetail=function(e){var t=a.confirm({title:"Remind "+s.showItem.other_user_name,template:"to add a proof of "+e+"?"})
t.then(function(t){t&&_(e,"request","requested")})},s.setShow=function(e){s.show=e},s.showTransaction=function(){console.log(s.showItem.id),e.go("showTransaction",{id:s.showItem.id,other_user_id:s.showItem.other_user_id})},s.goTo=function(t){e.go(t)},s.toggleItem=function(e){s.isItemShown(e)?s.showItem=null:(s.timeAgo=l.getAgoTime(e.updated_at),s.showItem=e)},s.isItemShown=function(e){return s.showItem===e},s.imageSizeLimit=2,s.filePath=null,s.fileToUpload={},s.file=null,s.filedata=null,s.imageSrc=null,s.progress=null,s.filename="",s.loadingFile=!1,s.loadStatus="",s.file_link="",s.loadImage=!1,s.removePicture=function(){s.filePath=null,s.fileToUpload={},s.file=null,s.filedata=null,s.imageSrc=null,s.progress=null},s.addPicture=function(){s.loadImage=!0
var e=document.getElementById("file").files[0],t=new FileReader
t.onload=function(t){s.filedata=t.currentTarget.result,s.filename=e.name,s.file=e,s.loadImage=!1,S()},t.readAsDataURL(e)},s.$on("fileProgress",function(e,t){s.progress=t.loaded/t.total*100}),s.submitFile=function(e){s.loadingFile=!0
var e=s.show.split("_")[1]
console.log(e),b(e)}}])
