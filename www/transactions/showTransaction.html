<ion-view>
<ion-content class="text-center has-header has-footer padding">

<div class="text-center" ng-show="showItemLoad">
    <img id="mySpinner" ng-src="{{APP_CONSTANT.LOADER}}"/>
</div>

<div ng-show="!showItemLoad">

<h2 class="title">Transaction Details</h2>
        <div class="item">
                <h2 ><strong>{{showItem.product_name}}</strong></h2>
                    
                    <h3 ng-if="userInSession.user_id == showItem.from_user_id">requested to 
                        <a ng-click="showUser({{showItem.to_user_id}})">{{showItem.other_user_name}}</a>
                    </h3 ng-if="userInSession.user_type=='supplier'">

                    <h3 ng-if="userInSession.user_id == showItem.to_user_id">requested from 
                        <a ng-click="showUser({{showItem.from_user_id}})">{{showItem.other_user_name}}</a>
                    </h3>
                    
                    <h4>
                        Last Updated : {{timeAgo}}
                    </h4>
                

                  <!-- ******************************************************************************************************************************* -->
                  <!--- STATUS AND PAYMENT STATUS FOR AGENT ****************************************************************************************** -->
                    <!-- GENERAL STATUS -->
                    
    
                    <span ng-if="showItem.status == TRANS_STATUS.REQUESTED" class="label label-success">Requested</span>
                    <span ng-if="showItem.status == TRANS_STATUS.DENIED" class="label label-danger">Denied</span>
                    <span ng-if="showItem.status == TRANS_STATUS.APPROVED" class="label label-success">Approved</span>
                    <span ng-if="showItem.status == TRANS_STATUS.DELIVERED && showItem.type == 'Delivery'" class="label label-success">Delivered</span>
                    <span ng-if="showItem.status == TRANS_STATUS.RECEIVED" class="label label-primary">Package Received</span>

                    <span ng-if="showItem.payment_status == TRANS_STATUS.NOT_PAID" class="label label-danger">Not Paid</span>
                    <span ng-if="showItem.payment_status == TRANS_STATUS.PAID" class="label label-success">Paid</span>
                    <span ng-if="showItem.payment_status == TRANS_STATUS.COMFIRMED" class="label label-primary">Payment Comfirmed</span>            
                    
                    <div style="padding:6px"></div>
                    <!-- ******************************************************************************************************************************* -->
                    <!-- ACTION FOR AGENT **********************************************************************************************************-->
                  <div ng-if="userInSession.user_id == showItem.from_user_id">
                                        
                    <button ng-if="showItem.status == TRANS_STATUS.DELIVERED"
                    ng-click="updateTrans({{showItem.id}},'status',TRANS_STATUS.RECEIVED)" 
                    class="button button-small button-outline button-positive icon-left ion-archive">Comfirm Package</button>
                
                    <button ng-if="showItem.payment_status == TRANS_STATUS.NOT_PAID && showItem.status > TRANS_STATUS.DENIED " 
                    ng-click="updateTrans({{showItem.id}},'payment_status',TRANS_STATUS.PAID)" 

                    class="button button-small button-outline button-balanced icon-left ion-cash">Pay Now</button>          

                    <button ng-if="showItem.status == TRANS_STATUS.DENIED || showItem.status == TRANS_STATUS.REQUESTED" 
                    ng-click="confirmDeleteTrans({{showItem.id}})" 
                    class="button button-small button-outline button-assertive icon-left ion-close-round">Remove Request</button>           
        
                  </div>

                  <!-- ******************************************************************************************************************************* -->
                  <!--- ACTION FOR SUPPLIER *************************************************************************************** -->
                  <div ng-if="userInSession.user_id == showItem.to_user_id">
     
                    <button ng-if="showItem.status == TRANS_STATUS.REQUESTED" 
                    ng-click="updateTrans({{showItem.id}},'status',TRANS_STATUS.APPROVED)" 
                    class="button button-small button-outline button-balanced icon-left ion-checkmark-round">Approve</button>
                
                    <button ng-if="showItem.status == TRANS_STATUS.REQUESTED" 
                    ng-click="updateTrans({{showItem.id}},'status',TRANS_STATUS.DENIED)"
                    class="button button-small button-outline button-assertive icon-left ion-close-round">Deny</button>
        
                    <button ng-if="showItem.status == TRANS_STATUS.APPROVED && showItem.type == 'Delivery'"
                    ng-click="updateTrans({{showItem.id}},'status',TRANS_STATUS.DELIVERED)" 
                    class="button button-small button-outline button-balanced icon-left ion-paper-airplane">Deliver</button>
        
                    <button ng-if="showItem.payment_status == TRANS_STATUS.PAID" 
                    ng-click="updateTrans({{showItem.id}},'payment_status',TRANS_STATUS.COMFIRMED)" 
                    class="button button-small button-outline button-balanced icon-left ion-checkmark-round">Confirm Payment</button>
        
                  </div>

            
        </div>

    <!--- TRANSACTION INFO AND -->
    <div class="item">

        <h4><strong>Price Per Unit</strong> | RM {{showProduct.price_per_unit}}</h4>
        <h4><strong>Quantity</strong> | {{showItem.quantity}}</h4>
        <h4><strong>Type</strong> | {{showItem.type}}</h4>
        <h4><strong>Total Price</strong> | RM {{showItem.total_price}} </h4>  

        <h4><strong>Category</strong> | {{showProduct.category}}</h4>


    </div>
        
     <!-- RELATED LINK -->
      <div class="item" ng-if="showItem.status >= TRANS_STATUS.DELIVERED || showItem.payment_status >= TRANS_STATUS.PAID">

        <span ng-if="show == 'info'">

            <span ng-if="showItem.status >= TRANS_STATUS.DELIVERED">
                <!-- DELIVERY DETAIL-->
                <button ng-disabled="showItem.delivery_detail == null || showItem.delivery_detail == 'requested' " 
                ng-click="openLink('delivery_detail')" 
                class="button button-small button-clear button-positive icon-right ion-paper-airplane">Delivery Comfirmation</button> 
            
                <span ng-if="showItem.delivery_detail == null || showItem.delivery_detail == 'requested' ">
                    
                    <!-- FOR SUPPLIER -->
                    <button ng-if="userInSession.user_id == showItem.to_user_id" 
                    ng-click="setShow('add_delivery_detail')" 
                    class="button button-small button-clear button-positive icon-right ion-paper-airplane">Add</button>  

                    <!-- FOR AGENT -->
                    <span ng-if = "userInSession.user_id == showItem.from_user_id">
                        <button ng-if="showItem.delivery_detail == null "
                        ng-click="requestDetail('delivery')" 
                        class="button button-small button-clear button-positive">Request</button>

                        <span ng-if="showItem.delivery_detail == 'requested' "
                        class="label label-primary">Requested</span>
                    </span>

                
                </span>
            </span>

            <br>

            <span ng-if="showItem.payment_status >= TRANS_STATUS.PAID">
                <!-- PAYMENT DETAIL-->
                <button ng-disabled="showItem.payment_detail == null || showItem.payment_detail == 'requested' " 
                ng-click="openLink('payment_detail')" 
                class="button button-small button-clear button-balanced icon-right ion-cash">Proof Of Payment</button>    

                <span ng-if="showItem.payment_detail == null || showItem.payment_detail == 'requested'">

                    <!-- FOR AGENT -->
                    <button ng-if="userInSession.user_id == showItem.from_user_id" 
                    ng-click="setShow('add_payment_detail')" 
                    class="button button-small button-clear button-balanced">Add</button>

                    <!-- FOR SUPPLIER -->
                    <span ng-if="userInSession.user_id == showItem.to_user_id">
                        <button ng-if="showItem.payment_detail == null"
                        ng-click="requestDetail('payment')" 
                        class="button button-small button-clear button-balanced">Request</button> 
                        
                        <span ng-if="showItem.payment_detail == 'requested' "
                        class="label label-success">Requested</span>
                    </span>
                </span>
            </span>
        </span>
        
        <span ng-if="show == 'add_payment_detail'">
            <h3 ><strong>Add Proof Of Payment</strong></h3>

        </span>        
        <span ng-if="show == 'add_delivery_detail'">
            <h3 ><strong>Add Delivery Confirmation</strong></h3>        
        </span>

        <br>

            <div ng-if="show == 'add_delivery_detail' || show == 'add_payment_detail'"> 
              
              <form role="form" accept="image/gif, image/jpeg">
              <div class="form-group" ng-form='insert_file_form'> 
                <div  ng-controller="AddFileController">
                <label ng-if="progress == null" class="item item-input">

                    <div>
                        <span class="input-label">Upload A Photo or File <h4>(Size Limit : {{imageSizeLimit}} MB) (only image or pdf accepted)</h4></span>
                        <input  type="file" id="file" name="file"   onchange="angular.element(this).scope().addPicture()" />
                    </div>      

                    <div class="text-center" ng-show="loadImage">
                        Adding Picture<br>
                        <img id="mySpinner" ng-src="{{APP_CONSTANT.LOADER}}"/>
                    </div>

                    </label> 

                    <img ng-if="imageSrc!=null" src="{{imageSrc}}" class="img-responsive img-thumbnail center-block" width="200">
                    <br>
                    <div ng-if="progress > 0">
                        <strong>{{filename}}</strong>
                    </div>
                    <button ng-if="progress > 0" class="button button-clear button-positive" ng-click="removePicture()">Remove File</button>

                    <div class="progress">
                      <div class="progress-bar progress-bar-striped active" role="progressbar"
                      aria-valuenow="{{progress}}" aria-valuemin="0" aria-valuemax="100" style="width:{{progress}}%">
                        {{progress}}%
                      </div>
                    </div>

                </div>

                    <br>
                    <div class="button-bar">
                      <a ng-disabled="!insert_file_form.$valid" class="button button-small button-balanced" ng-click="addDetail()">Add</a> 
                      <a class="button button-small button-assertive" ng-click="setShow('info')">Cancel</a>
                    </div>
                </div>
              </form>
            </div>

                
      </div>

</div>
</ion-view>
</ion-content>