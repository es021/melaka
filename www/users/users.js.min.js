var myApp=angular.module("sample.users",["ui.router","backand","auth0","ngCookies"])
myApp.config(["$stateProvider",function(e){e.state("findUser",{url:"/findUser?user_type_request",controller:"FindUserController",templateUrl:"users/findUser.html",data:{requiresLogin:!1}}),e.state("allUsers",{url:"/allUsers?user_type&pageNumber",controller:"AllUserController",templateUrl:"users/allUsers.html",data:{requiresLogin:!1}}),e.state("showUser",{url:"/showUser?id",controller:"ShowUserController",templateUrl:"users/showUser.html",data:{requiresLogin:!1}}),e.state("myProfile",{url:"/myProfile",controller:"MyProfileController",templateUrl:"users/myProfile.html",data:{requiresLogin:!0}}),e.state("myLinkedUser",{url:"/myLinkedUser?refresh&pageNumber",controller:"LinkedUserController",templateUrl:"users/myLinkedUser.html",data:{requiresLogin:!0}}),e.state("myPendingLinkRequest",{url:"/myPendingLinkRequest?refresh",controller:"PendingLinkController",templateUrl:"users/myPendingLinkRequest.html",data:{requiresLogin:!0}})}]),myApp.controller("AllUserController",["$scope","USER_TYPE","SearchService","UserService","PublicService","BackandService","auth","OFFSET","$state","$location","$stateParams",function(e,o,s,r,t,n,i,l,u,a,c){function d(o){var r=0
try{r=o.length}catch(e){console.log(e)}r<3||(e.searchLoad=!0,s.searchUserByNameTypeFixed(o,e.user_type).then(function(o){e.searchUser=o.data,console.log(o),e.searchLoad=!1},function(o){t.errorCallbackFunction(o,"default"),e.searchLoad=!1}))}function f(){e.loading=!0,n.getTopUserByUserType(e.user_type,null,c.pageNumber).then(function(o){e.users=o.data,console.log(o),e.loading=!1},function(o){t.errorCallbackFunction(o,"default"),e.loading=!1})}e.user_type=c.user_type,e.users=[],e.loading=!1,e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.pageNumber=c.pageNumber,console.log(e.pageNumber),e.OFFSET=l,e.search={},e.searchUser=[],e.searchLoad=!1,e.isSubmit=!1,e.submit=function(){e.search.key&&""!=e.search.key||(e.searchUser=[]),e.isSubmit=!0,d(e.search.key)},e.getMore=function(o){console.log(o)
var s=e.pageNumber
"next"==o&&(s=Number(e.pageNumber)+1),"previous"==o&&(s=Number(e.pageNumber)-1),console.log(s),u.go(u.current.name,{user_type:c.user_type,pageNumber:s})},f()}]),myApp.controller("FindUserController",["$scope","USER_TYPE","PublicService","UserService","SearchService","BackandService","auth","$state","$location","$stateParams",function(e,o,s,r,t,n,i,l,u,a){function c(o,r){var n=0
try{n=o.length}catch(e){console.log(e)}n<3||(e.searchLoad=!0,t.searchUserByNameByType(o,r).then(function(o){e.users=o.data,console.log(o),e.searchLoad=!1},function(o){s.errorCallbackFunction(o,"default"),e.searchLoad=!1}))}function d(s){var r=3,t=1
n.getTopUserByUserType(s,r,t).then(function(r){console.log("getUserByType"),console.log(r),s==o.SUPPLIER&&(e.suppliers=r.data,e.loadSupplier=!1),s==o.STOCKIST&&(e.stockists=r.data,e.loadStockist=!1),s==o.DROPSHIP&&(e.dropships=r.data,e.loadDropship=!1)})}function f(r){n.getUserCountByUserType(r).then(function(s){r==o.SUPPLIER&&(e.suppliersCount=s.data[0].total_user),r==o.STOCKIST&&(e.stockistsCount=s.data[0].total_user),r==o.DROPSHIP&&(e.dropshipsCount=s.data[0].total_user),e.userCount_load[r]=!1},function(e){s.errorCallbackFunction(e,"default")})}function g(){for(var o=1;o<=3;o++)d(o),e.userCount_load[o]=!0,f(o)}e.user_type_request=a.user_type_request,e.USER_TYPE=o,console.log(e.user_type_request),e.suppliers={},e.stockists={},e.dropships={},e.loadSupplier=!0,e.loadStockist=!0,e.loadDropship=!0,e.userCount_load=["count",0,0,0],e.suppliersCount=0,e.stockistsCount=0,e.dropshipsCount=0,e.search={},e.search.key=a.searchKey,e.user_type=o.ALL,e.users=[],e.searchLoad=!1,e.isSubmit=!1,e.submit=function(){e.search.key||(e.users=[]),e.isSubmit=!0,c(e.search.key,e.search.user_type)},e.findMore=function(e){console.log("find more "+e),l.go("allUsers",{user_type:e,pageNumber:1})},g()}]),myApp.controller("ShowUserController",["$scope","NOTI_CATEGORY","$ionicPopup","PublicService","BackandService","auth","growl","$state","$stateParams","USER_LINK_TYPE",function(e,o,s,r,t,n,i,l,u,a){function c(){d(e.session_user_id,e.show_user_id,a.REQUESTED_BY_USER),d(e.show_user_id,e.session_user_id,a.REQUESTED_TO_USER),e.userInSession.user_type==e.showObject.user_type&&(e.userLinkType=a.SAME_TYPE)}function d(o,s,r){t.getUserLink(o,s).then(function(o){console.log("Data from get link object"),console.log(o),o.data.length>0&&(e.linkObject=o.data[0],null!=o.data[0].id&&(e.user_link_id=o.data[0].id),o.data[0].type==a.REQUESTED&&r==a.REQUESTED_BY_USER&&(e.userLinkType=a.REQUESTED,e.isRequestByUser=!0),o.data[0].type==a.REQUESTED&&r==a.REQUESTED_TO_USER?(e.userLinkType=a.REQUESTED,e.isRequestToUser=!0):e.userLinkType=o.data[0].type)},function(e){})}function f(o,s){var r=""
r=o.data.includes("Duplicate entry")?"The email is already taken by another "+type:"Please try again",i.error(r,{title:s+" Failed!"}),console.log(o),e.loading=!1}function g(o,s,r){t.addObject(o,s).then(function(s){console.log("Return Result from Adding to "+o),console.log(s),e.loading=!1,200==s.status&&(i.success("",{title:""+r}),e.userLinkType=a.REQUESTED,e.user_link_id=s.data.id,e.isRequestToUser=!1,e.isRequestByUser=!0)},function(e){f(e,"Request")})}function m(o,s){e.showObjectLoad=!0,t.getObjectById(o,s).then(function(o){console.log("Data from show object"),e.showObject=o.data,console.log(e.showObject),200==o.status&&(e.showObject.created_at=r.getDate(e.showObject.created_at)),e.showObjectLoad=!1},function(o){f(o,"Error in Retrieving Info"),e.errorMessage="There is no user with id "+s,e.showObjectLoad=!1})}function p(o,s){var n=r.getTimestampinMysql()
t.editUserLinkById(o,s,n).then(function(o){console.log("Data from edit link object"),console.log(o),e.loading=!1,200==o.status&&(i.success("",{title:"Successfully Edit Record!"}),e.userLinkType=s,e.isRequestToUser=!1,e.isRequestByUser=!1)},function(e){f(e,"Comfirm Request")})}function y(o){t.deleteObject("userLinks",o).then(function(o){console.log("Data from delete link object"),console.log(o),e.loading=!1,200==o.status&&(i.success("",{title:"Successfully Delete Record!"}),e.userLinkType=a.NOT_REQUESTED,e.isRequestToUser=!1,e.isRequestByUser=!1)},function(e){f(e,"Remove Request")})}function h(o){e.loadingProducts=!0,t.getProductBySupplierId(o).then(function(o){console.log("Result From getProductBySupplierId"),e.myProductsObject=o.data,200==o.status,e.loadingProducts=!1})}if(e.loading=!1,e.loadingProducts=!1,e.show="info",e.showObject={},e.showObjectLoad=!1,e.USER_LINK_TYPE=a,e.user_link_id=null,e.userLinkType=a.NOT_REQUESTED,e.isRequestToUser=!1,e.isRequestByUser=!1,e.fullAddress=!1,e.show_user_id=u.id,e.toggleFullAddress=function(){e.fullAddress?e.fullAddress=!1:e.fullAddress=!0},e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),null!=e.userInSession){if(console.log("USER IN SESSION"),console.log(e.userInSession),e.linkObject={},e.session_user_id=e.userInSession.user_id,e.userInSession.user_id==e.show_user_id)return void l.go("myProfile")
console.log("Showing User "+e.show_user_id),c()}m("users",e.show_user_id),e.linkUser=function(r){if(e.loading=!0,"sendRequest"==r){var n={}
n.to_user_id=e.show_user_id,n.from_user_id=e.session_user_id,n.type=a.REQUESTED,n.created_at=t.getTimestampinMysql(),n.update_at=t.getTimestampinMysql(),g("userLinks",n,"Request Sent!"),t.createNotification(e.show_user_id,"You got a new link request from "+e.userInSession.first_name,"/showUser?id="+e.userInSession.user_id,o.LINK)}if("cancelRequest"==r||"ignoreRequest"==r||"removeFromList"==r){e.loading=!1
var i=s.confirm({title:"Are You Sure?",template:"This action cannot be undone."})
i.then(function(s){if(s&&(e.loading=!0,y(e.user_link_id),"removeFromList"==r)){var n="You were removed you from "+e.userInSession.first_name+"'s list"
t.createNotification(e.show_user_id,n,"/showUser?id="+e.userInSession.user_id,o.LINK)}})}"confirmRequest"==r&&(p(e.user_link_id,a.LINKED),t.createNotification(e.show_user_id,"You are now linked with "+e.userInSession.first_name,"/showUser?id="+e.userInSession.user_id,o.LINK))},e.showFunction=function(o){console.log(e.myProductsObject),e.show=o,"products"==o&&null==e.myProductsObject&&h(e.id)}}]),myApp.controller("LinkedUserController",["$scope","growl","OFFSET","$state","$stateParams","UserService","BackandService","PublicService","SearchService","USER_LINK_TYPE",function(e,o,s,r,t,n,i,l,u,a){function c(o){var s=0
try{s=o.length}catch(e){console.log(e)}s<3||(e.searchLoad=!0,u.searchLinkedUserByNameByState(o,e.userInSession.user_id).then(function(o){e.searchProduct=o.data,console.log(o),e.searchLoad=!1},function(o){l.errorCallbackFunction(o,"default"),e.searchLoad=!1}))}function d(){e.myLinkedUser={},e.myLinkedUserLoad=!0}function f(){console.log("initAgentLinked"),d(),g(e.userInSession.user_id)}function g(o){i.getLinkedUserById(o,e.pageNumber).then(function(o){console.log("Getting all getLinkedUserById"),200==o.status&&(e.myLinkedUser=o.data,e.myLinkedUserLoad=!1)},function(e){l.errorCallbackFunction(e,"Failed : getLinkedUserById")})}e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.pageNumber=t.pageNumber,console.log(e.pageNumber),e.OFFSET=s,e.search={},e.searchProduct=[],e.searchLoad=!1,e.isSubmit=!1,e.submit=function(){e.search.key&&""!=e.search.key||(e.searchProduct=[]),e.isSubmit=!0,c(e.search.key)},e.refresh=function(){f(),o.info("List is up to date",{title:"Refresh List!"})},null!=e.userInSession?f():r.go("login"),e.getMore=function(o){console.log(o)
var s=e.pageNumber
"next"==o&&(s=Number(e.pageNumber)+1),"previous"==o&&(s=Number(e.pageNumber)-1),console.log(s),r.go(r.current.name,{pageNumber:s})}}]),myApp.controller("PendingLinkController",["$scope","$state","$stateParams","UserService","BackandService","PublicService","USER_LINK_TYPE",function(e,o,s,r,t,n,i){function l(){e.requestedToUser={},e.requestedFromUser={},e.requestedToUserLoad=!0,e.requestedFromUserLoad=!0}function u(){console.log("initAgentPending"),l(),a(e.userInSession.user_id),c(e.userInSession.user_id)}function a(o){t.getRequestToUserById(o).then(function(o){console.log("Getting all getRequestToUserById"),200==o.status&&(e.requestedToUser=o.data,e.requestedToUserLoad=!1)},function(e){n.errorCallbackFunction(e,"Failed : getRequestToUserById")})}function c(o){t.getRequestFromUserById(o).then(function(o){console.log("Getting all getRequestFromUserById"),200==o.status&&(e.requestedFromUser=o.data,e.requestedFromUserLoad=!1)},function(e){n.errorCallbackFunction(e,"Failed : getRequestFromUserById")})}e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.refresh=function(){u()},null!=e.userInSession?u():o.go("login")}]),myApp.controller("MyProfileController",["$scope","growl","$state","UserService","BackandService","PublicService","USER_LINK_TYPE","USER_TYPE",function(e,o,s,r,t,n,i,l){function u(o,s){e.myProfileLoad=!0,t.getObjectById(o,s).then(function(o){console.log("Data from show object"),e.myProfile=o.data,e.oldProfile=o.data,console.log(e.myProfile),200==o.status,e.myProfileLoad=!1},function(o){e.myProfileLoad=!1,userLinkErrorCallback(o,"Error in Retrieving Info")})}e.authProfile=JSON.parse(window.localStorage.getItem("AuthProfile")),e.userInSession=JSON.parse(window.localStorage.getItem("UserInSession")),e.myProfile=null,e.oldProfile=null,e.myProfileLoad=!1,e.page="show",e.fullAddress=!1,e.toggleFullAddress=function(){e.fullAddress?e.fullAddress=!1:e.fullAddress=!0},e.USER_TYPE=l,e.submitEditProfile=function(){e.oldProfile=e.myProfile,console.log("submitEditProfile"),e.loadStatus="Editing old record in database",e.myProfile.updated_at=n.getTimestampinMysql(),console.log(e.myProfile),t.editUserById(e.myProfile.id,e.myProfile.first_name,e.myProfile.last_name,e.myProfile.company_name,e.myProfile.address_line_1,e.myProfile.address_line_2,e.myProfile.city,e.myProfile.state,e.myProfile.postal_code,e.myProfile.email,e.myProfile.phone_number,e.myProfile.about,e.myProfile.updated_at).then(function(s){console.log("Result From Editing Profile"),console.log(s),200==s.status&&(o.success("",{title:"Successfully Edit Your Product!"}),e.page="show"),e.loading=!1},function(e){n.errorCallbackFunction(e,"Failed to edit your profile")})},e.editProfile=function(){e.page="edit",e.oldProfile=JSON.parse(JSON.stringify(e.myProfile))},e.showProfile=function(){e.page="show",console.log(e.oldProfile),console.log(e.myProfile),e.myProfile=e.oldProfile},e.showProductList=function(e){s.go("showProductList",{user_id:e,pageNumber:1})},console.log(null==e.userInSession),null!=e.userInSession?u("users",e.userInSession.user_id):console.log(e.authProfile)}])
